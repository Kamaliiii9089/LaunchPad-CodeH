name: Auto Review and Merge PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Request Copilot Review
        uses: actions/github-script@v7
        with:
          script: |
            // Add a comment requesting Copilot review
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `ü§ñ **Copilot Auto-Review Initiated**\n\nRunning automated checks on this PR...`
            });

      - name: Run automated checks
        id: checks
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            let reviewComments = [];
            let approved = true;

            // Check PR title format
            if (!pr.title || pr.title.length < 10) {
              reviewComments.push('‚ùå PR title should be descriptive (at least 10 characters)');
              approved = false;
            }

            // Check PR description
            if (!pr.body || pr.body.length < 20) {
              reviewComments.push('‚ùå PR description should provide details (at least 20 characters)');
              approved = false;
            }

            // Check file count (warn if too many files changed)
            if (pr.changed_files > 50) {
              reviewComments.push('‚ö†Ô∏è This PR changes more than 50 files. Consider splitting into smaller PRs.');
            }

            // Check additions/deletions ratio
            if (pr.additions > 1000) {
              reviewComments.push('‚ö†Ô∏è Large PR with 1000+ additions. Please ensure adequate testing.');
            }

            // Post review
            if (reviewComments.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `### ü§ñ Copilot Auto-Review\n\n${reviewComments.join('\n')}\n\n${approved ? '‚úÖ Automated checks passed!' : '‚ö†Ô∏è Please address the issues above.'}`
              });
            }

            core.setOutput('approved', approved);
            return approved;

  auto-merge:
    runs-on: ubuntu-latest
    needs: copilot-review
    if: |
      github.event_name == 'check_suite' && 
      github.event.check_suite.conclusion == 'success' &&
      github.event.check_suite.pull_requests[0] != null
    steps:
      - name: Auto-merge PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.check_suite.pull_requests[0].number;
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Check if PR is mergeable
            if (!pr.mergeable) {
              console.log('PR is not mergeable');
              return;
            }

            // Check if all checks have passed
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            const allChecksPassed = checks.check_runs.every(
              check => check.conclusion === 'success' || check.conclusion === 'neutral'
            );

            if (!allChecksPassed) {
              console.log('Not all checks have passed');
              return;
            }

            // Check for required labels (optional - adjust as needed)
            const hasECWoCLabel = pr.labels.some(label => label.name === 'ECWoC26');
            
            if (!hasECWoCLabel) {
              console.log('Missing required label: ECWoC26');
              return;
            }

            // Auto-approve the PR
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: '‚úÖ **Auto-approved by Copilot**\n\nAll automated checks passed successfully!'
              });

              console.log('PR approved');
            } catch (error) {
              console.log('Could not approve (might be PR author):', error.message);
            }

            // Merge the PR
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash', // Options: 'merge', 'squash', 'rebase'
                commit_title: `${pr.title} (#${prNumber})`,
                commit_message: `Auto-merged by Copilot\n\n${pr.body || ''}`
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'üéâ **Auto-merged successfully!**\n\nThis PR has been automatically merged after passing all checks.'
              });

              console.log(`Successfully merged PR #${prNumber}`);
            } catch (error) {
              console.log('Failed to merge:', error.message);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `‚ö†Ô∏è **Auto-merge failed**\n\nReason: ${error.message}\n\nPlease merge manually.`
              });
            }
